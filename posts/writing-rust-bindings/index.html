<!doctype html><html><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><title>
         Writing Rust Bindings for My Python App
        
    </title><meta content="Writing Rust Bindings for My Python App" property=og:title><meta content="Walk through my experience of writing Rust FFI for my Python CLI application" property=og:description><meta content="Walk through my experience of writing Rust FFI for my Python CLI application" name=description><link href=https://dhruvahuja.me/fonts.css rel=stylesheet><script async data-goatcounter=https://dhruv-ahuja.goatcounter.com/count src=https://dhruvahuja.me/js/count.js></script><noscript><img src="https://dhruv-ahuja.goatcounter.com//count?p=/posts/writing-rust-bindings/&t=Writing Rust Bindings for My Python App"></noscript><link href=https://dhruvahuja.me/atom.xml rel=alternate title=dhruv-ahuja type=application/atom+xml><link href=https://dhruvahuja.me/main.css media=screen rel=stylesheet><link href=https://dhruvahuja.me/theme/light.css rel=stylesheet><link media="(prefers-color-scheme: dark)" href=https://dhruvahuja.me/theme/dark.css rel=stylesheet><script src=https://dhruvahuja.me/js/feather.min.js></script><body><div class=content><header><div class=main><a href=https://dhruvahuja.me>dhruv-ahuja</a><div class=socials><a class=social href=mailto:dhruvahuja2k@gmail.com rel=me target=_blank> <img alt=email src=/social_icons/email.svg> </a><a class=social href=https://www.linkedin.com/in/dhruvahuja2k/ rel=me target=_blank> <img alt=linkedin src=/social_icons/linkedin.svg> </a><a class=social href=https://github.com/dhruv-ahuja/ rel=me target=_blank> <img alt=github src=/social_icons/github.svg> </a></div></div><nav><a href=/posts style=margin-left:.7em>/posts</a><a href=/projects style=margin-left:.7em>/projects</a> | <a href id=dark-mode-toggle onclick=toggleTheme()></a><script src=https://dhruvahuja.me/js/themetoggle.js></script></nav></header><main><article><div class=title><div class=page-header>Writing Rust Bindings for My Python App<span class=primary-color style=font-size:1.6em>.</span></div><div class=meta>Posted on <time>06-11-2023</time></div></div><section class=body><h2 id=introduction>Introduction</h2><p><a href=https://github.com/dhruv-ahuja/spoti-dl title=https://github.com/dhruv-ahuja/spoti-dl>spoti-dl</a>, a Python-based CLI song downloading tool was the first “proper” application that I developed. It acted as a proof-of-concept of my programming skills as a self-taught developer, and helped me land my first job. However, it lacked some basic features, mainly- no parallel downloads for albums and playlists.<p>I recently added a few new features and re-wrote its core functionality in Rust, as I have been enjoying working with Rust’s robust type system, compiler-level error handling and syntax.<h2 id=development>Development</h2><p>Development was relatively smooth for the most part, as the app logic is straightforward — you accept and parse the input Spotify link, the CLI flag parameters and process downloads. I figured out general things by googling and/or through some experimentation, such as the trait implementations to parse CLI flags from <code>String</code>s into <code>enum</code>s and vice-versa. The <code>lazy_static</code> macro helped me allocate a static <code>HashSet</code> containing disallowed characters for files and folder names, on runtime. I also became more comfortable with bound traits and experienced the power of generics. I was able to use the following function across all of my download flows, as it accepts any input <code>P</code> that can be referenced as <code>Path</code> and any input <code>S</code> that can be converted into a <code>String</code> type:<pre class=language-rust data-lang=rust style=background:#212121;color:#eeffff><code class=language-rust data-lang=rust><span style=color:#c792ea>pub </span><span style=font-style:italic;color:#c792ea>fn </span><span style=color:#82aaff>add_metadata</span><span style=color:#89ddff><</span><span>P, S</span><span style=color:#89ddff>>(
</span><span>    </span><span style=color:#f78c6c>file_path</span><span style=color:#89ddff>:</span><span> P,
</span><span>    </span><span style=color:#f78c6c>album_art_path</span><span style=color:#89ddff>:</span><span> P,
</span><span>    </span><span style=color:#f78c6c>simple_song</span><span style=color:#89ddff>: </span><span>spotify</span><span style=color:#89ddff>::</span><span>SimpleSong,
</span><span>    </span><span style=color:#f78c6c>album_name</span><span style=color:#89ddff>:</span><span> S,
</span><span style=color:#89ddff>) </span><span style=color:#c792ea>where
</span><span>    P</span><span style=color:#89ddff>: </span><span style=color:#ffcb6b>AsRef</span><span style=color:#89ddff><</span><span>Path</span><span style=color:#89ddff>></span><span> + Debug,
</span><span>    S</span><span style=color:#89ddff>: </span><span style=color:#ffcb6b>Into</span><span style=color:#89ddff><</span><span style=color:#ffcb6b>String</span><span style=color:#89ddff>></span><span>,
</span><span style=color:#89ddff>{...}
</span></code></pre><p>I mainly struggled when implementing the async logic to download songs in parallel, due to my inexperience with writing async code in Rust. I had to spend a lot of time working with the compiler’s restrictions and <a href=https://tokio.rs/ title=https://tokio.rs/>Tokio’s</a> <code>’static + Send</code> requirements for spawning tasks, as its work-stealing scheduler model means that a task running in one thread could be picked up by another thread. I used <code>tokio::task::block_in_place</code> to wrap the <code>add_metadata</code> function call as the <a href=https://github.com/Serial-ATA/lofty-rs title=https://github.com/Serial-ATA/lofty-rs>lofty</a> crate does not support async.<p>I added a CLI flag, allowing users to specify the number of tasks to use to process parallel downloads, and used batch downloads of 100 songs for playlists, as they can contain several thousands of songs.<p>The following is the core async logic for parallel downloads — calculate songs to be downloaded by each task, make <code>Arc</code>s to pass cheap, shareable clones for certain values, chunk the list of songs and create and wait for the spawned tasks to finish downloads:<pre class=language-rust data-lang=rust style=background:#212121;color:#eeffff><code class=language-rust data-lang=rust><span style=font-style:italic;color:#c792ea>let</span><span> parallel_tasks</span><span style=color:#89ddff>: </span><span style=font-style:italic;color:#c792ea>usize </span><span style=color:#89ddff>= </span><span style=font-style:italic;color:#c792ea>if</span><span> album</span><span style=color:#89ddff>.</span><span>songs</span><span style=color:#89ddff>.</span><span style=color:#82aaff>len</span><span style=color:#89ddff>() >=</span><span> cli_args</span><span style=color:#89ddff>.</span><span>parallel_downloads </span><span style=color:#89ddff>as </span><span style=font-style:italic;color:#c792ea>usize </span><span style=color:#89ddff>{
</span><span>    cli_args</span><span style=color:#89ddff>.</span><span>parallel_downloads </span><span style=color:#89ddff>as </span><span style=font-style:italic;color:#c792ea>usize
</span><span style=color:#89ddff>} </span><span style=font-style:italic;color:#c792ea>else </span><span style=color:#89ddff>{
</span><span>    album</span><span style=color:#89ddff>.</span><span>songs</span><span style=color:#89ddff>.</span><span style=color:#82aaff>len</span><span style=color:#89ddff>()
</span><span style=color:#89ddff>};
</span><span>
</span><span style=font-style:italic;color:#c792ea>let</span><span> songs_per_task </span><span style=color:#89ddff>=</span><span> album</span><span style=color:#89ddff>.</span><span>songs</span><span style=color:#89ddff>.</span><span style=color:#82aaff>len</span><span style=color:#89ddff>() /</span><span> parallel_tasks</span><span style=color:#89ddff>;
</span><span style=font-style:italic;color:#c792ea>let</span><span> remaining_songs </span><span style=color:#89ddff>=</span><span> album</span><span style=color:#89ddff>.</span><span>songs</span><span style=color:#89ddff>.</span><span style=color:#82aaff>len</span><span style=color:#89ddff>() %</span><span> parallel_tasks</span><span style=color:#89ddff>;
</span><span>
</span><span style=font-style:italic;color:#c792ea>let</span><span> cli_args </span><span style=color:#89ddff>= </span><span>Arc</span><span style=color:#89ddff>::</span><span>new</span><span style=color:#89ddff>(</span><span>cli_args</span><span style=color:#89ddff>);
</span><span style=font-style:italic;color:#c792ea>let</span><span> album_art_dir </span><span style=color:#89ddff>= </span><span>Arc</span><span style=color:#89ddff>::</span><span>new</span><span style=color:#89ddff>(</span><span>album_art_dir</span><span style=color:#89ddff>);
</span><span style=font-style:italic;color:#c792ea>let</span><span> album_name </span><span style=color:#89ddff>= </span><span>Arc</span><span style=color:#89ddff>::</span><span>new</span><span style=color:#89ddff>(</span><span>album</span><span style=color:#89ddff>.</span><span>name</span><span style=color:#89ddff>);
</span><span>
</span><span style=font-style:italic;color:#c792ea>let </span><span style=color:#c792ea>mut</span><span> handles </span><span style=color:#89ddff>= </span><span style=color:#ffcb6b>Vec</span><span style=color:#89ddff>::</span><span>with_capacity</span><span style=color:#89ddff>(</span><span>parallel_tasks</span><span style=color:#89ddff>);
</span><span style=font-style:italic;color:#c792ea>let </span><span style=color:#c792ea>mut</span><span> start </span><span style=color:#89ddff>= </span><span style=color:#f78c6c>0</span><span style=color:#89ddff>;
</span><span>
</span><span style=font-style:italic;color:#c792ea>for</span><span> i </span><span style=color:#89ddff>in </span><span style=color:#f78c6c>0</span><span style=color:#89ddff>..</span><span>parallel_tasks </span><span style=color:#89ddff>{
</span><span>    </span><span style=font-style:italic;color:#c792ea>let </span><span style=color:#c792ea>mut</span><span> end </span><span style=color:#89ddff>=</span><span> start </span><span style=color:#89ddff>+</span><span> songs_per_task</span><span style=color:#89ddff>;
</span><span>    </span><span style=font-style:italic;color:#c792ea>if</span><span> i </span><span style=color:#89ddff><</span><span> remaining_songs </span><span style=color:#89ddff>{
</span><span>        end </span><span style=color:#89ddff>+= </span><span style=color:#f78c6c>1
</span><span>    </span><span style=color:#89ddff>}
</span><span>
</span><span>    </span><span style=font-style:italic;color:#c792ea>let</span><span> songs_chunk </span><span style=color:#89ddff>= &</span><span>album</span><span style=color:#89ddff>.</span><span>songs</span><span style=color:#89ddff>[</span><span>start</span><span style=color:#89ddff>..</span><span>end</span><span style=color:#89ddff>];
</span><span>    </span><span style=font-style:italic;color:#c792ea>let</span><span> handle </span><span style=color:#89ddff>= </span><span>tokio</span><span style=color:#89ddff>::</span><span>spawn</span><span style=color:#89ddff>(</span><span style=color:#82aaff>download_songs</span><span style=color:#89ddff>(
</span><span>        file_path</span><span style=color:#89ddff>.</span><span style=color:#82aaff>clone</span><span style=color:#89ddff>(),
</span><span>        cli_args</span><span style=color:#89ddff>.</span><span style=color:#82aaff>clone</span><span style=color:#89ddff>(),
</span><span>        album_art_dir</span><span style=color:#89ddff>.</span><span style=color:#82aaff>clone</span><span style=color:#89ddff>(),
</span><span>        album_name</span><span style=color:#89ddff>.</span><span style=color:#82aaff>clone</span><span style=color:#89ddff>(),
</span><span>        songs_chunk</span><span style=color:#89ddff>.</span><span style=color:#82aaff>to_vec</span><span style=color:#89ddff>(),
</span><span>    </span><span style=color:#89ddff>));
</span><span>
</span><span>    start </span><span style=color:#89ddff>=</span><span> end</span><span style=color:#89ddff>;
</span><span>    handles</span><span style=color:#89ddff>.</span><span style=color:#82aaff>push</span><span style=color:#89ddff>(</span><span>handle</span><span style=color:#89ddff>)
</span><span style=color:#89ddff>}
</span><span>
</span><span style=font-style:italic;color:#c792ea>for</span><span> handle </span><span style=color:#89ddff>in</span><span> handles </span><span style=color:#89ddff>{
</span><span>    handle</span><span style=color:#89ddff>.</span><span>await</span><span style=color:#89ddff>?;
</span><span style=color:#89ddff>}
</span></code></pre><h2 id=tooling>Tooling</h2><p>I dropped <a href=https://python-poetry.org/ title=https://python-poetry.org/>Poetry</a> as it would not be compatible with the Rust bindings and used simple virtual environments for dependency management, and <a href=https://twine.readthedocs.io/en/stable/ title=https://twine.readthedocs.io/en/stable/>Twine</a> for distributing built wheels.<p><a href=https://pyo3.rs/v0.20.0/ title=https://pyo3.rs/v0.20.0/>Pyo3</a> acts as the bridge between the parent Python code that calls a single exposed Rust function and enables all the inter-op between the two systems. <a href=https://github.com/PyO3/maturin title=https://github.com/PyO3/maturin>Maturin</a> compiles the Rust code into a Python library, and also compiles both codebases into a distributable Python wheel.<p>The following is a list of changes I had to make in my <code>Cargo</code> and <code>pyproject</code> TOML files, to ensure that the build process and <code>pip</code> installed package worked as intended:<ul><li><p><code>Maturin</code> did not recognize the project as a mixed Python-Rust project, hence did not include Rust code in the distributable Python wheel. Setting <code>lib.name</code> table’s value to match Python source directory (<code>spotidl</code>) in <code>Cargo.toml</code> fixed this error.</p><li><p><code>pyproject.toml</code> required several modifications — I needed to set the <code>project.scripts</code> value to <code>spoti-dl = "spotidl.main:main"</code>, partially because the project name (<code>spoti-dl</code>) and Python source directory names were different. I also added the <code>python-packages = ["spotidl"]</code> value under <code>tool.maturin</code> to ensure its inclusion during the build process. I also had to add my dependencies and relevant project metadata in their apt sections, after dropping <code>Poetry</code>.</p><li><p><code>Maturin</code> compiles the Rust code as a library inside our Python source directory. It adds an underscore <code>_</code> to the library’s name by default, which is quite confusing. I rectified this by configuring the <code>module-name</code> value under <code>tool.maturin</code>.</p></ul><p>I faced several problems when attempting to build wheels for Linux using Docker, on my M1 MacBook. I must have easily spent 15-20 hours trying to get the <code>openssl-sys</code> crate to compile as it was the single point of failure, using both the python <code>manylinux</code> and <code>maturin</code> Docker images. I tried to integrate a CI/CD setup using GitHub Actions too, but to no avail, as the crate kept failing to compile. You can check the graveyard of my CI’s failed runs <a href=https://github.com/dhruv-ahuja/spoti-dl/actions title=https://github.com/dhruv-ahuja/spoti-dl/actions>here</a>. Eventually I had to settle for manually compiling wheels on Linux, Mac and Windows and copying them to a folder before publishing them with <code>Twine</code>.<h2 id=conclusion>Conclusion</h2><p>This was a rewarding experience for me, as I dealt with efficiently processing large amounts of data and sharpened my skills with Rust and <code>Tokio</code>.<p>I witnessed a 20-25% speed increase and 50% less memory consumption in my Rust code when downloading a single song. The development process was smooth as <code>Pyo3</code> and <code>Maturin</code> are very well-documented and provide convenient APIs, make it incredibly easy to get started with writing FFIs for Python.</section></article></main></div></body><footer><p>Made with <a href=https://www.getzola.org/ target=_blank>Zola</a>, using a <a href=https://github.com/dhruv-ahuja/apollo-custom target=_blank>custom variant</a> of the <a href=https://github.com/not-matthias/apollo target=_blank>Apollo</a> theme.</footer>